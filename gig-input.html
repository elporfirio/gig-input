<!--
 Webcomponents to manage input
 @version v0.0.10 - 2015-12-27
 @link https://github.com/gigigo-html5/gig-input
 @author Pedro José Peña Jerez <pedro.jose@gigigo.com>
 @license MIT License, http://www.opensource.org/licenses/MIT
 -->
<link href="../polymer/polymer.html">
<script src="colorpicker.js"></script>

<style>
/* Common stuff */
.picker-wrapper,
.slide-wrapper {
    position: relative;
    float: left;
}
.picker-indicator,
.slide-indicator {
    position: absolute;
    left: 0;
    top: 0;
    pointer-events: none;
}
.picker,
.slide {
    cursor: crosshair;
    float: left;
}

/* Default skin */

.cp-default {
    background-color: white;
    border: 1px solid #e4eaec;
    padding: 7px;
    margin-top: 5px;
    box-shadow: 0 3px 12px rgba(0,0,0,.05);
    border-radius: 3px;
    position:absolute;
    z-index: 100000;
}
.cp-default .picker {
    width: 150px;
    height: 150px;
}
.cp-default .slide {
    width: 30px;
    height: 150px;
    margin-left: 5px;
}
.cp-default .slide-wrapper {
    margin-left: 10px;
}
.cp-default .picker-indicator {
    width: 5px;
    height: 5px;
    border: 2px solid darkblue;
    -moz-border-radius: 4px;
    -o-border-radius: 4px;
    -webkit-border-radius: 4px;
    border-radius: 4px;
    opacity: .5;
    -ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=50)";
    filter: progid:DXImageTransform.Microsoft.Alpha(Opacity=50);
    filter: alpha(opacity=50);
    background-color: white;
}
.cp-default .slide-indicator {
    width: 100%;
    height: 10px;
    left: -4px;
    opacity: .6;
    -ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=60)";
    filter: progid:DXImageTransform.Microsoft.Alpha(Opacity=60);
    filter: alpha(opacity=60);
    border: 4px solid lightblue;
    -moz-border-radius: 4px;
    -o-border-radius: 4px;
    -webkit-border-radius: 4px;
    border-radius: 4px;
    background-color: white;
}


</style>

<script>
    Polymer.GigInputColorBehavior = {
        enableColor: function() {
            var self = this;
            ColorPicker(
                this.querySelector('.slide'),
                this.querySelector('.picker'),
                function(hex, hsv, rgb) {
                    self.value = hex;
                }
            );
        },
        hideColor: function() {
            this.showColor = false;
        }

    }
</script>

<link href="../polymer/polymer.html">
<script src="../pikaday-time/pikaday.js"></script>
<script src="../moment/moment.js"></script>
<script src="../moment/locale/es.js"></script>
<link rel="stylesheet" href="../pikaday-time/css/pikaday.css">


<script>
    Polymer.GigInputDateBehavior = {
        enableDate: function() {
            self = this;

            if (this.type == 'datetime') {
                this.showTime = true;
            } else {
                this.showTime = false;
            }

            moment.locale(self.lang);

            var picker = new Pikaday({
                showTime: this.showTime,
                use24hour: true,
                field: this.$.input,
                format: this.formatDate,
                position: 'bottom left',
                reposition: false,
                minDate: this.minDate,
                i18n: {
                    previousMonth : 'Previous Month',
                    nextMonth     : 'Next Month',
                    months        : moment.localeData()._months,
                    weekdays      : moment.localeData()._weekdays,
                    weekdaysShort : moment.localeData()._weekdaysShort
                },
                onSelect: function (date) {
                    self.$.input.value = moment(date).format(self.formatDate);
                }
            });

        },
        properties: {
            formatDate: {
                type: String,
                notify: true
            },
            minDate: {
                type: Date,
                value: null
            }
        }

    }
</script>


<link rel="import" href="..//polymer/polymer.html">
<link rel="import" href="..//iron-overlay-behavior/iron-overlay-backdrop.html">
<link rel="import" href="gig-input-date-behavior.html">
<link rel="import" href="gig-input-color-behavior.html">
<link rel="stylesheet" href="..//components-font-awesome/css/font-awesome.css">
<link rel="import" href="..//iron-validatable-behavior/iron-validatable-behavior.html">
<link rel="import" href="..//iron-form-element-behavior/iron-form-element-behavior.html">
<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
<script>
  WebFont.load({
    google: {
      families: ['Roboto:300,400']
    }
  });
</script>

<dom-module id="gig-input">

    <style>

        * {
            box-sizing: border-box;
            font-family: Roboto,sans-serif;
        }

        input {
            display: block;
            width: 100%;
            height: 36px;
            padding: 6px 15px;
            font-size: 14px;
            line-height: 1.57142857;
            font-weight: 300;
            color: var(--input-color-primary, #76838f);
            background-color: #fff;
            background-image: none;
            border: 1px solid var(--input-border-color, #e4eaec);
            border-radius: 3px;
            -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075);
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075);
            -webkit-transition: border-color ease-in-out .15s, -webkit-box-shadow ease-in-out .15s;
            -o-transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s;
            transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s;
            @apply(--input-style);
        }
        input:focus {
            border-color: var(--input-border-color-focus, #62a8ea);
            outline: 0;
            -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(98, 168, 234, .6);
            box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(98, 168, 234, .6);
        }
        input.focus,
        input:focus {
            border-color: var(--input-border-color-focus, #62a8ea);
            -webkit-box-shadow: none;
            box-shadow: none;
        }
        input::-moz-placeholder {
            color: var(--input-color-placeholder, #a3afb7);
            opacity: 1;
        }
        input:-ms-input-placeholder {
            color: var(--input-color-placeholder, #a3afb7);
        }
        input::-webkit-input-placeholder {
            color: var(--input-color-placeholder, #a3afb7);
        }
        input::-ms-expand {
            background-color: transparent;
            border: 0;
        }
        input[disabled],
        input[readonly],
        fieldset[disabled] .form-control {
            background-color: var(--input-background-color-disabled, #f3f7f9);
            opacity: 1;
        }

        input.error {
            border-color: var(--input-color-error, #f96868);
        }

        .error {
            color: var(--input-color-error, #f96868);
        }

        div.error {
            padding: 5px 0;
        }

        .small {
            font-size: 85%;
        }

        .maxlength {
            float: right;
            border-radius: 3px;
            margin: 5px 0;
            color: white;
            font-weight: bold;
            padding: 2px 5px;
            font-size: 75%;
            display: block
        }

        .maxlength.success {
            background-color: var(--input-color-success, #46BE8A);
        }

        .maxlength.error {
            background-color: var(--input-color-error, #f96868);
            color: white !important;
        }

        .field-group {
            display: -webkit-flex;
            -webkit-align-items: center;
            display: flex;
            align-items: center;
        }

        .group-icon input {
            border-bottom-right-radius: 0;
            border-top-right-radius: 0;
        }

        .group input {
            border-bottom-left-radius: 0;
            border-top-left-radius: 0;
        }

        .field-group span {
            display: inline-block;
            background-color: #f3f7f9;
            border: 1px solid #e4eaec;
            border-radius: 3px;
            white-space: nowrap;
            vertical-align: middle;
            color: #76838f;
            font-size: 14px;
            float: right;
            height: 36px;
            text-align: center;
            line-height: 34px;
            border-right: 0;
            padding: 0 10px;
            border-bottom-right-radius: 0;
            border-top-right-radius: 0;
        }

        .field-group span.icon {
            width: 36px;
            height: 36px;
            padding: 0;
            border-bottom-left-radius: 0;
            border-top-left-radius: 0;
            border-bottom-right-radius: 3px;
            border-top-right-radius: 3px;
            border-left: 0;
            border-right: 1px solid #e4eaec;
        }

        .field-group span.icon i {
            display: block;
            width: 16px;
            height: 16px;
            margin: 10px;
            cursor: pointer;
        }

        iron-overlay-backdrop {
            z-index: 1000;
        }

    </style>

    <template>
        <div class="field-group" class$="[[getClassGroup(icon, group, type)]]">

            <template is="dom-if" if="[[group]]">
                <span>[[group]]</span>
            </template>

        <input id="input"
               autocomplete$="[[autocomplete]]"
               required$="[[required]]"
               placeholder$="[[placeholder]]"
               readonly$="[[readonly]]"
               minlength$="[[minlength]]"
               maxlength$="[[maxlength]]"
               min$="[[min]]"
               max$="[[max]]"
               step$="[[step]]"
               name$="[[name]]"
               readonly$="[[readonly]]"
               type="{{typeFormat}}"
               value="[[value]]"
               class$="[[getClassList(errorMessage)]]"
               on-keyup="keyupEvent"
               on-focus="focusEvent"
               on-blur="blurEvent">

               <template is="dom-if" if="[[icon]]">
                   <span class$="[[getClassIcon(icon)]]"></span>
               </template>

               <template is="dom-if" if="[[checkColor(type)]]">
                   <span class$="[[getClassIcon(icon)]]"><i style$="background-color: [[value]]" on-click="focusInput"></i></span>
               </template>

        </div>

        <template is="dom-if" if="[[checkColor(type)]]" on-dom-change="readyTemplate" id="color">
            <div class="modal-color cp-default" hidden$="{{!showColor}}">
                <div class="picker"></div>
                <div class="slide"></div>
            </div>

        </template>

        <template is="dom-if" if="[[errorMessage]]">
            <div class="error small">[[errorMessage]]</div>
        </template>

        <template is="dom-if" if="{{maxLengthShow}}">
            <span class$="[[_getMaxLengthClass(value, maxlength)]]"><span>{{length(value)}}</span> / <span>{{maxlength}}</span></span>
        </template>

        <iron-overlay-backdrop hidden$="{{!showColor}}" id="overlay" on-click="hideColor"></iron-overlay-backdrop>

    </template>

    <script>
        (function() {

            var self;

            function validateEmail(email) {
                var re = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;
                return re.test(email);
            }

            Polymer({
                is: 'gig-input',
                behaviors: [
                    Polymer.GigInputDateBehavior,
                    Polymer.GigInputColorBehavior,
                    Polymer.IronFormElementBehavior,
                    Polymer.IronValidatableBehavior
                ],
                listeners: {
                    'input': '_onInput'
                },
                _onInput: function() {
                     if (this._getValidity()) {
                         this.errorMessage = null;
                     }
                },
                _getValidity: function() {
                    if (this.type === 'email') {
                        return validateEmail(this.value);
                    } else {
                        return this.value != '';
                    }
                },
                focusInput: function() {
                    this.$.input.focus();
                },
                readyTemplate: function() {
                    if (this.type === 'color') {
                        this.enableColor();
                    }
                },
                ready: function() {
                    this._checkType();
                    if (this.type === 'date' || this.type === 'datetime') {
                        this.enableDate(this.type);
                    }


                    this._getValidity();
                },
                getClassGroup: function(icon, group, type) {
                    var classList = 'field-group';

                    if (icon || type == 'color') {
                        classList += ' group-icon';
                    }

                    if (group) {
                        classList += ' group';
                    }

                    return classList;
                },
                checkColor: function(type) {
                    if (type === 'color') {
                        return true;
                    }
                },
                getClassIcon: function(icon) {
                    return 'icon fa '+icon;
                },
                getClassList: function(errorMessage) {
                    var classList = '';

                    if (errorMessage) {
                        classList += 'error';
                    }

                    return classList;
                },
                keyupEvent: function () {
                    self = this;
                    switch(this.type) {
                        case 'slug':
                            self.value = self._generatorSlug(self.$.input.value)
                            break;
                        default:
                            self.value = self.$.input.value;
                        break;
                    }
                    this._checkMaxLength();
                },
                focusEvent: function(e) {
                    this._checkMaxLength();

                    if (this.type === 'color') {
                        this.showColor = true;
                    }
                },
                blurEvent: function() {
                    this.maxLengthShow = false;
                },
                length: function(value) {
                    return value.length;
                },
                _checkMaxLength: function() {

                    if (this.$.input.value && this.maxlength) {
                        var percentage = ((this.$.input.value.length / this.maxlength) * 100).toFixed(2);

                        if (percentage > 70) {
                            this.maxLengthShow = true;
                        } else {
                            this.maxLengthShow = false;
                        }
                    }

                },
                _getMaxLengthClass: function(value, maxlength) {

                    var classList = 'maxlength';
                    var percentage = ((value.length / maxlength) * 100).toFixed(2);

                    if (percentage < 100) {
                        classList += ' success';
                    } else {
                        classList += ' error';
                    }

                    return classList;

                },
                _generatorSlug: function(str) {
                    str = str.replace(/^\s+|\s+$/g, '');
                    str = str.toLowerCase();

                    var from = "ãàáäâẽèéëêìíïîõòóöôùúüûñç·/_,:;";
                    var to   = "aaaaaeeeeeiiiiooooouuuunc------";
                    for (var i=0, l=from.length ; i<l ; i++) {
                        str = str.replace(new RegExp(from.charAt(i), 'g'), to.charAt(i));
                    }

                    str = str.replace(/[^a-z0-9 -]/g, '')
                            .replace(/\s+/g, '-')
                            .replace(/-+/g, '-');

                    return str;
                },
                _checkType: function() {
                    if (this.type === 'slug' || this.type === 'date' || this.type === 'color') {
                        this.typeFormat = 'text';
                    }
                    else {
                        this.typeFormat = this.type;
                    }
                },
                properties: {
                    name: {
                        type: String,
                        notify: true
                    },
                    value: {
                        type: String,
                        value: '',
                        notify: true,
                        reflectToAttribute: true
                    },
                    required: {
                        type: Boolean,
                        value: false
                    },
                    readonly: {
                        type: Boolean,
                        value: false
                    },
                    disabled: {
                        type: Boolean,
                        value: false
                    },
                    type: {
                        type: String,
                        value: 'text',
                        notify: true
                    },
                    typeFormat: {
                        type: String,
                        value: 'text',
                        notify: true
                    },
                    maxlength: {
                        type: Number
                    },
                    maxLengthShow: {
                        type: Boolean,
                        notify: true
                    },
                    icon: {
                        type: String,
                        value: null
                    },
                    lang: {
                        type: String,
                        value: 'en',
                        notify: true
                    },
                    group: {
                        type: String,
                        value: null
                    },
                    showColor: {
                        type: Boolean,
                        value: false
                    }
                }
            })
        })();
    </script>

</dom-module>
